name: TITAN-V147-DIRECT-FIREFOX

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9600

    steps:
      - name: 1. Setup Environment & Direct Firefox Download
        run: |
          Stop-Service -Name wuauserv, SysMain, AudioEndpointBuilder, audiosrv -Force
          pip install psutil requests --quiet
          # Direct Firefox Portable download and extract
          $ffUrl = "https://sourceforge.net/projects/portableapps/files/Mozilla%20Firefox%2C%20Portable%20Ed./Mozilla%20Firefox%2C%20Portable%20Edition%20122.0/FirefoxPortable_122.0_English.paf.exe/download"
          Invoke-WebRequest -Uri $ffUrl -OutFile "ff_setup.exe"
          Start-Process "ff_setup.exe" -ArgumentList "/S" -Wait # Silent Install

      - name: 2. Tailscale Interactive Login (2 Minute Wait)
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet", "/norestart" -Wait
          
          Write-Host "`n#######################################################" -ForegroundColor Cyan
          Write-Host "STEP 1: CLICK THE LINK BELOW TO LOGIN (YOU HAVE 2 MINUTES)" -ForegroundColor Yellow
          
          # Force generating a login link
          Start-Process "$env:ProgramFiles\Tailscale\tailscale.exe" -ArgumentList "up"
          
          Write-Host "LOGS KO DEKHTE RAHEN, LOGIN URL UPAR AA CHUKA HOGA..." -ForegroundColor White
          Start-Sleep -Seconds 120
          
          $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4)
          Write-Host "#######################################################" -ForegroundColor Cyan
          Write-Host "SUCCESS! YOUR RDP IP IS: $tsIP" -ForegroundColor Green -BackgroundColor Black
          Write-Host "USERNAME: RDP | PASSWORD: Admin@Watch786" -ForegroundColor White
          Write-Host "#######################################################`n"

      - name: 3. Create Firefox Master Script
        run: |
          $password = "Admin@Watch786"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (!(Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          }

          $firefoxScript = @"
          import os, time, subprocess, psutil, requests, random

          links = [
              "https://m.youtube.com/watch?v=oiyYa3IL2Rc",
              "https://m.youtube.com/watch?v=OXuTuHQqB7s",
              "https://m.youtube.com/watch?v=K9ihEWJn4Go",
              "https://m.youtube.com/watch?v=z25lo2mogbk",
              "https://m.youtube.com/watch?v=ZkJlQ_q7x5Q"
          ]

          def start_firefox():
              # Typical path after silent install
              ff_path = r'C:\FirefoxPortable\FirefoxPortable.exe'
              if not os.path.exists(ff_path):
                  ff_path = r'C:\Users\runneradmin\Desktop\FirefoxPortable\FirefoxPortable.exe'

              for i in range(15):
                  p_dir = f'C:\Users\Public\FF_Profile_{i}'
                  if not os.path.exists(p_dir): os.makedirs(p_dir)
                  subprocess.Popen([ff_path, "-new-instance", "-profile", p_dir, links[i % len(links)]])
                  time.sleep(15)

          while True:
              [p.kill() for p in psutil.process_iter(['name']) if 'firefox' in p.info['name'].lower()]
              time.sleep(5)
              start_firefox()
              time.sleep(10800) 
          "@
          $firefoxScript | Out-File -FilePath "C:\Users\Public\Desktop\TITAN_FIREFOX.py" -Encoding ascii
          "@echo off`npython C:\Users\Public\Desktop\TITAN_FIREFOX.py`npause" | Out-File -FilePath "C:\Users\Public\Desktop\START_FIREFOX.bat" -Encoding ascii

      - name: 4. Final Keep-Alive
        run: Start-Sleep -Seconds 9000
