name: DUBBED-DHAMAAL-V102-TITAN-FIXED

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9600

    steps:
      - name: 1. Core Engine Setup
        run: |
          Stop-Service -Name wuauserv, SysMain -Force
          pip install pyautogui opencv-python numpy
          choco install googlechrome --accept-license -y

      - name: 2. Tailscale Login (IP & Link Recovery)
        continue-on-error: true 
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet", "/norestart" -Wait
          
          Write-Host "------------------------------------------------------"
          Write-Host "TITAN CONNECTION SYSTEM STARTING..."
          
          # Force link if key is invalid
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=titan-v102 --accept-routes --force-reauth
          
          # Wait a bit for you to see the link
          Start-Sleep -Seconds 30
          Write-Host "Checking Status..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" status
          Write-Host "------------------------------------------------------"

      - name: 3. Registry Hack (0% Network & Freeze Fix)
        run: |
          $regPath = "HKLM:\SOFTWARE\Policies\Google\Chrome"
          if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
          Set-ItemProperty -Path $regPath -Name "BackgroundModeEnabled" -Value 1
          
          $password = "Admin@Watch786"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (!(Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          }

      - name: 4. Launch Always-Active Browsers
        run: |
          $channel = "Dubbed Dhamaal TV"
          $chrome = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          foreach ($i in 1..12) {
            $searchUrl = "https://www.youtube.com/results?search_query=" + $channel.Replace(" ", "+")
            $flags = @(
              "--user-data-dir=C:\Profiles\Titan_$i",
              "--no-sandbox",
              "--disable-blink-features=AutomationControlled",
              "--disable-features=CalculateNativeWinOcclusion", # ðŸ”¥ Fixes 0% Network
              "--mute-audio",
              "$searchUrl"
            )
            Start-Process $chrome -ArgumentList $flags
            Start-Sleep -Seconds 10
          }

      - name: 5. Run AI "Active-Human" Brain
        shell: python
        env:
          PYTHONIOENCODING: utf-8
        run: |
          import pyautogui
          import time
          import random
          import sys

          # No emojis here to prevent UnicodeEncodeError
          print("AI Titan V102: System Online. Monitoring Activity...")
          
          time.sleep(30)
          
          while True:
              try:
                  # Move mouse to keep screen from turning black
                  pyautogui.moveTo(random.randint(200, 800), random.randint(200, 600), duration=1)
                  
                  # Switch Tabs
                  pyautogui.keyDown('alt')
                  pyautogui.press('tab')
                  pyautogui.keyUp('alt')
                  
                  # Interaction to trigger network
                  pyautogui.click()
                  pyautogui.press('k')
                  
                  print("Titan Heartbeat: Network Active.")
                  time.sleep(random.randint(30, 60))
              except Exception as e:
                  print("Fixing minor glitch...")
                  time.sleep(10)
