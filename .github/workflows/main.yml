name: DUBBED-DHAMAAL-V112-FORCE-RUN

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9600

    steps:
      - name: 1. Setup & Requirements (Final Fix)
        run: |
          Stop-Service -Name wuauserv, SysMain -Force
          # Force install specific versions to avoid crash
          python -m pip install --upgrade pip
          pip install pyautogui psutil --quiet
          choco install googlechrome --accept-license -y

      - name: 2. Tailscale Tunnel
        continue-on-error: true 
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname="titan-v112" --accept-routes --force-reauth
          Start-Sleep -Seconds 20

      - name: 3. Create RDP & Debug-Enabled Script
        run: |
          $password = "Admin@Watch786"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (!(Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          }
          
          # Ye script ab crash hone par Error File banayegi
          $debugScript = @"
          import os
          import time
          import subprocess
          import sys

          # Logs create karne ke liye
          log_file = r'C:\Users\Public\Desktop\error_log.txt'
          
          def log_error(msg):
              with open(log_file, 'a') as f:
                  f.write(f"[{time.strftime('%H:%M:%S')}] {msg}\n")

          try:
              log_error("Script Started Successfully")
              
              links = [
                  "https://youtu.be/oiyYa3IL2Rc?si=LnzHB2SnxLvotRp-",
                  "https://youtu.be/OXuTuHQqB7s?si=hsLjg-WN4Kddl2en",
                  "https://youtu.be/K9ihEWJn4Go?si=VMP02dzeGwZtH_G0",
                  "https://youtu.be/z25lo2mogbk?si=RDQn25eKVGl6u8Dy",
                  "https://youtu.be/ZkJlQ_q7x5Q?si=5vafU9AuYNTZcp5E"
              ]
              
              chrome_path = r'C:\Program Files\Google\Chrome\Application\chrome.exe'
              
              if not os.path.exists(chrome_path):
                  log_error("Chrome Path NOT FOUND!")
                  sys.exit()

              print("Launching Browsers... Check Desktop for logs if it crashes.")
              
              for i in range(15): # Reduced to 15 for stability
                  try:
                      url = links[i % len(links)]
                      profile = f'--user-data-dir=C:\\Profiles\\Titan_{i}'
                      # Minimal flags to ensure it opens
                      cmd = [chrome_path, profile, '--guest', '--no-first-run', '--mute-audio', url]
                      subprocess.Popen(cmd)
                      log_error(f"Profile {i} Launched")
                      time.sleep(5)
                  except Exception as e:
                      log_error(f"Failed to launch profile {i}: {str(e)}")

              print("Running Anti-Freeze. Keep this window open.")
              while True:
                  time.sleep(60)

          except Exception as e:
              log_error(f"CRITICAL SCRIPT ERROR: {str(e)}")
          "@
          $debugScript | Out-File -FilePath "C:\Users\Public\Desktop\TITAN_V112.py" -Encoding ascii

      - name: 4. Final Success
        run: |
          Write-Host "RDP User: RDP | Pass: Admin@Watch786"
          Write-Host "Run 'TITAN_V112.py' from Desktop."
          Start-Sleep -Seconds 9000
