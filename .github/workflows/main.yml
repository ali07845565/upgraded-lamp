name: DUBBED-DHAMAAL-V27-ULTIMATE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9600

    steps:
      - name: 1. Setup Graphics & AI Engine
        run: |
          Stop-Service -Name wuauserv, SysMain -Force
          pip install google-genai pyautogui opencv-python numpy
          choco install googlechrome --accept-license -y

      - name: 2. Tailscale Secure Login (IP & Link)
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile "ts.msi"
          Start-Process msiexec.exe -ArgumentList "/i", "ts.msi", "/quiet", "/norestart" -Wait
          
          Write-Host "üîó Connecting to Tailscale..."
          # Key se login ki koshish
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=dhamaal-v27 --accept-routes --force-reauth
          
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if (-not $tsIP) {
              Write-Host "‚ö†Ô∏è Key failed! Login using this QR/Link below:"
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=dhamaal-v27 --qr
          } else {
              Write-Host "‚úÖ TAILSCALE IP: $tsIP"
          }

      - name: 3. Create RDP & Anti-Freeze Registry
        run: |
          $password = "Admin@Watch786"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (!(Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          }
          
          # 0% Network Fix: Force Windows to render background apps
          $regPath = "HKLM:\SOFTWARE\Policies\Google\Chrome"
          if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
          Set-ItemProperty -Path $regPath -Name "BackgroundModeEnabled" -Value 1
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'ExtendedUIHoverTime' -Value 1

      - name: 4. Launch Organic AI Matrix (Dubbed Dhamaal TV)
        run: |
          $channel = "Dubbed Dhamaal TV"
          $chrome = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          foreach ($i in 1..15) {
            # Search Engine Link (Mimics real traffic)
            $searchUrl = "https://www.youtube.com/results?search_query=" + $channel.Replace(" ", "+")
            $flags = @(
              "--user-data-dir=C:\Profiles\AI_$i",
              "--no-sandbox",
              "--disable-blink-features=AutomationControlled",
              "--disable-background-timer-throttling",
              "--disable-backgrounding-occluded-windows",
              "--disable-renderer-backgrounding",
              "--force-device-scale-factor=0.6",
              "--mute-audio",
              "$searchUrl"
            )
            Start-Process $chrome -ArgumentList $flags
            Start-Sleep -Seconds 10
          }

      - name: 5. Gemini-Powered "Human Soul" Agent
        shell: python
        run: |
          import pyautogui
          import time
          import random
          
          print("AI Brain V27: Forcing Network Activity & Views...")
          time.sleep(60) # Initial Loading
          
          while True:
              try:
                  # Step 1: Switch Window
                  pyautogui.keyDown('alt')
                  pyautogui.press('tab')
                  pyautogui.keyUp('alt')
                  time.sleep(2)
                  
                  # Step 2: Organic Interaction (Click to Play)
                  # Click on the center to start video if stuck
                  pyautogui.click(640, 480) 
                  pyautogui.press('k') # Force Play
                  
                  # Step 3: Anti-Freeze Scrolling
                  pyautogui.scroll(random.randint(-500, 500))
                  
                  # Step 4: Quality Pulse (144p toggle)
                  pyautogui.press('s') 
                  
                  print(f"AI: Active Pulse sent. Time: {time.strftime('%H:%M:%S')}")
                  time.sleep(random.randint(40, 70))
              except:
                  time.sleep(5)
